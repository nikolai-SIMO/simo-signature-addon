<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://appsforoffice.microsoft.com; style-src 'self' 'unsafe-inline'; img-src 'self' https: data:; connect-src 'self' https:;">
    <title>SIMO Email Signatures</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        /* ==================== CSS VARIABLES ==================== */
        :root {
            --color-primary: #3d5875;
            --color-primary-dark: #2a3f54;
            --color-secondary: #6c757d;
            --color-success: #28a745;
            --color-error: #dc3545;
            --color-warning: #ffc107;
            --color-info: #2196f3;
            --color-text: #333333;
            --color-text-muted: #666666;
            --color-text-light: #9a9a9a;
            --color-background: #f5f7fa;
            --color-card: #ffffff;
            --color-border: #e1e4e8;
            --color-toggle-off: #d1d5db;
            --font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            --border-radius: 6px;
            --border-radius-lg: 8px;
            --transition-fast: 0.2s ease;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --focus-ring: 0 0 0 3px rgba(61, 88, 117, 0.3);
        }

        /* ==================== RESET & BASE ==================== */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
        }

        /* ==================== FOCUS STATES (Accessibility) ==================== */
        :focus { outline: none; }
        :focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        /* ==================== SKIP LINK (Accessibility) ==================== */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--color-primary);
            color: white;
            padding: 8px 16px;
            z-index: 100;
            transition: top var(--transition-fast);
        }
        .skip-link:focus { top: 0; }

        /* ==================== HEADER ==================== */
        .header {
            background: var(--color-primary);
            color: white;
            padding: 16px 24px;
            border-bottom: 3px solid var(--color-primary-dark);
        }
        .header h1 { font-size: 20px; font-weight: 600; }
        .header p { font-size: 13px; opacity: 0.9; margin-top: 4px; }

        /* ==================== LAYOUT ==================== */
        .container { padding: 20px; max-width: 800px; margin: 0 auto; }

        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text { font-size: 14px; color: var(--color-text-muted); }

        /* ==================== PAGES ==================== */
        .page { display: none; }
        .page.active { display: block; }

        /* ==================== CARDS ==================== */
        .card {
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--color-primary);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            width: 100%;
        }
        .btn:focus-visible { box-shadow: var(--focus-ring); }

        .btn-primary { background: var(--color-primary); color: white; }
        .btn-primary:hover { background: var(--color-primary-dark); }
        .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }

        .btn-secondary {
            background: var(--color-card);
            color: var(--color-primary);
            border: 2px solid var(--color-primary);
            margin-top: 12px;
        }
        .btn-secondary:hover { background: #f6f8fa; }

        .btn-back {
            background: var(--color-secondary);
            color: white;
            margin-bottom: 20px;
            width: auto;
        }
        .btn-back:hover { background: #5a6268; }

        /* ==================== PREVIEW ==================== */
        .preview-box {
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 20px;
            background: #fafbfc;
            margin-top: 16px;
            max-height: 500px;
            overflow-y: auto;
        }

        /* ==================== FORMS ==================== */
        .settings-section { margin-bottom: 32px; }
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-border);
        }

        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--color-text);
        }
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-toggle-off);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: border-color var(--transition-fast);
        }
        .form-input:focus { border-color: var(--color-primary); }

        /* ==================== TOGGLE SWITCHES (Accessible) ==================== */
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f9fafb;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
        }
        .toggle-info { flex: 1; }
        .toggle-label { font-size: 14px; font-weight: 500; color: var(--color-text); }
        .toggle-description { font-size: 12px; color: var(--color-text-muted); margin-top: 2px; }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--color-toggle-off);
            border-radius: 12px;
            cursor: pointer;
            transition: background var(--transition-fast);
            flex-shrink: 0;
            border: none;
            padding: 0;
        }
        .toggle-switch:focus-visible { box-shadow: var(--focus-ring); }
        .toggle-switch[aria-checked="true"] { background: var(--color-primary); }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }
        .toggle-switch[aria-checked="true"]::after { transform: translateX(24px); }

        /* ==================== NOTIFICATIONS ==================== */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-success);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            role: status;
            aria-live: polite;
        }
        .save-indicator.show { opacity: 1; }
        .save-indicator.error { background: var(--color-error); }

        /* ==================== ALERT BOXES ==================== */
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 13px;
            border-left: 4px solid;
        }
        .alert-info { background: #e3f2fd; border-color: var(--color-info); color: #1565c0; }
        .alert-warning { background: #fff3cd; border-color: var(--color-warning); color: #856404; }
        .alert-error { background: #f8d7da; border-color: var(--color-error); color: #721c24; display: none; }

        /* ==================== STATUS BADGE ==================== */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        .status-badge.ready { background: #d4edda; color: #155724; }
        .status-badge.loading { background: #fff3cd; color: #856404; }
        .status-badge.error { background: #f8d7da; color: #721c24; }
        .status-badge.test { background: #cce5ff; color: #004085; }

        /* ==================== DEBUG PANEL ==================== */
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: var(--border-radius);
            padding: 12px;
            margin-top: 20px;
            font-size: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }
        .debug-panel.show { display: block; }

        /* ==================== SCREEN READER ONLY ==================== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#mainContent" class="skip-link">Skip to main content</a>

    <header class="header" role="banner">
        <h1>SIMO Email Signatures <span id="statusBadge" class="status-badge loading" role="status" aria-live="polite">Loading...</span></h1>
        <p>Professional signatures for your organization</p>
    </header>

    <main id="mainContent" role="main">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading-screen" aria-busy="true" aria-label="Loading application">
            <div class="spinner" role="img" aria-label="Loading spinner"></div>
            <div class="loading-text" id="loadingText" aria-live="polite">Initializing add-in...</div>
        </div>

        <!-- Application Content -->
        <div id="appContent" style="display: none;">
            <div class="container">
                <!-- Error Display -->
                <div id="errorDisplay" class="alert alert-error" role="alert" aria-live="assertive"></div>

                <!-- Main Page -->
                <section id="mainPage" class="page active" aria-labelledby="mainPageTitle">
                    <div class="card">
                        <h2 id="mainPageTitle" class="card-title">Your Email Signature</h2>
                        <p style="margin-bottom: 16px;">Apply your personalized SIMO signature to your emails. Customize it in Settings.</p>
                        <button id="applyBtn" class="btn btn-primary" type="button" aria-describedby="applyBtnDesc">
                            Apply Signature
                        </button>
                        <span id="applyBtnDesc" class="sr-only">Insert your signature into the current email</span>
                        <button id="settingsBtn" class="btn btn-secondary" type="button">
                            Signature Settings
                        </button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">Preview</h3>
                        <div id="previewBox" class="preview-box" role="region" aria-label="Signature preview" aria-live="polite">
                            <p style="color: #666; font-style: italic;">Loading signature preview...</p>
                        </div>
                    </div>

                    <!-- Debug Panel -->
                    <div id="debugPanel" class="debug-panel" role="log" aria-label="Debug information">
                        <strong>Debug Log:</strong><br>
                        <div id="debugLog"></div>
                    </div>
                </section>

                <!-- Settings Page -->
                <section id="settingsPage" class="page" aria-labelledby="settingsPageTitle">
                    <button id="backBtn" class="btn btn-back" type="button" aria-label="Go back to main page">
                        &larr; Back to Main
                    </button>

                    <div class="card">
                        <h2 id="settingsPageTitle" class="card-title">Signature Settings</h2>

                        <div class="alert alert-info" role="note">
                            Your name and email are automatically loaded from your Microsoft 365 profile.
                        </div>

                        <!-- Contact Information Section -->
                        <fieldset class="settings-section">
                            <legend class="settings-section-title">Contact Information</legend>

                            <div class="form-group">
                                <label class="form-label" for="personalMobile">Personal Mobile Number</label>
                                <input type="tel"
                                       id="personalMobile"
                                       class="form-input"
                                       placeholder="+49 (0)123 456789"
                                       autocomplete="tel">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="companyLandline">Company Landline Number</label>
                                <input type="tel"
                                       id="companyLandline"
                                       class="form-input"
                                       placeholder="+49 (0)6021 3274550"
                                       autocomplete="tel">
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="personalEmail">Personal Email (if different from Microsoft 365)</label>
                                <input type="email"
                                       id="personalEmail"
                                       class="form-input"
                                       placeholder="your.email@example.com"
                                       autocomplete="email">
                            </div>
                        </fieldset>

                        <!-- Signature Elements Section -->
                        <fieldset class="settings-section">
                            <legend class="settings-section-title">Signature Elements</legend>

                            <div class="toggle-group">
                                <div class="toggle-info">
                                    <div class="toggle-label" id="labelProfilePic">Show Profile Picture</div>
                                    <div class="toggle-description">Display your Microsoft 365 profile photo</div>
                                </div>
                                <button type="button"
                                        id="toggleProfilePic"
                                        class="toggle-switch"
                                        role="switch"
                                        aria-checked="true"
                                        aria-labelledby="labelProfilePic"
                                        data-setting="showProfilePic"></button>
                            </div>

                            <div class="toggle-group">
                                <div class="toggle-info">
                                    <div class="toggle-label" id="labelPersonalMobile">Show Personal Mobile</div>
                                    <div class="toggle-description">Display your personal mobile number</div>
                                </div>
                                <button type="button"
                                        id="togglePersonalMobile"
                                        class="toggle-switch"
                                        role="switch"
                                        aria-checked="false"
                                        aria-labelledby="labelPersonalMobile"
                                        data-setting="showPersonalMobile"></button>
                            </div>

                            <div class="toggle-group">
                                <div class="toggle-info">
                                    <div class="toggle-label" id="labelCompanyLandline">Show Company Landline</div>
                                    <div class="toggle-description">Display company phone number</div>
                                </div>
                                <button type="button"
                                        id="toggleCompanyLandline"
                                        class="toggle-switch"
                                        role="switch"
                                        aria-checked="true"
                                        aria-labelledby="labelCompanyLandline"
                                        data-setting="showCompanyLandline"></button>
                            </div>

                            <div class="toggle-group">
                                <div class="toggle-info">
                                    <div class="toggle-label" id="labelPersonalEmail">Show Personal Email</div>
                                    <div class="toggle-description">Use personal email instead of Microsoft 365 email</div>
                                </div>
                                <button type="button"
                                        id="togglePersonalEmail"
                                        class="toggle-switch"
                                        role="switch"
                                        aria-checked="false"
                                        aria-labelledby="labelPersonalEmail"
                                        data-setting="showPersonalEmail"></button>
                            </div>

                            <div class="toggle-group">
                                <div class="toggle-info">
                                    <div class="toggle-label" id="labelSocialMedia">Show Social Media Icons</div>
                                    <div class="toggle-description">LinkedIn, Teams, Facebook, Instagram, YouTube, TikTok</div>
                                </div>
                                <button type="button"
                                        id="toggleSocialMedia"
                                        class="toggle-switch"
                                        role="switch"
                                        aria-checked="true"
                                        aria-labelledby="labelSocialMedia"
                                        data-setting="showSocialMedia"></button>
                            </div>
                        </fieldset>

                        <button id="saveBtn" class="btn btn-primary" type="button">Save Settings</button>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="saveIndicator" class="save-indicator" role="status" aria-live="polite"></div>

    <script>
    (function() {
        'use strict';

        // ==================== CONFIGURATION ====================
        var CONFIG = Object.freeze({
            INIT_TIMEOUT: 5000,
            TOAST_DURATION: 3000,
            MAX_LOG_ENTRIES: 20,
            PHOTO_SIZE: 80,
            ICON_SIZE: 32,
            STORAGE_KEY: 'simoSignatureSettings',
            VERSION: '1.0.0.5'
        });

        var COMPANY_INFO = Object.freeze({
            name: 'SIMO GmbH',
            address: 'Wuerzburger Strasse 152',
            city: '63743 Aschaffenburg',
            phone: '+49 (0)6021 3274550',
            fax: '+49 (0)6021 3274560',
            email: 'info@simo-online.com',
            website: 'https://www.simo-online.com',
            logoUrl: 'https://nikolai-simo.github.io/simo-signature-addon/simo-logo.png',
            social: Object.freeze({
                linkedin: 'https://www.linkedin.com/company/69697053/',
                facebook: 'https://www.facebook.com/simomakedataeasy',
                instagram: 'https://www.instagram.com/simo_makedataeasy/',
                youtube: 'https://www.youtube.com/@SIMOMakeDataEasy',
                tiktok: 'https://www.tiktok.com/@simo.makedataeasy'
            })
        });

        var SOCIAL_ICONS = Object.freeze([
            { id: 'linkedin', url: COMPANY_INFO.social.linkedin, icon: 'https://nikolai-simo.github.io/simo-signature-addon/icons/linkedin.png', alt: 'LinkedIn' },
            { id: 'teams', url: null, icon: 'https://nikolai-simo.github.io/simo-signature-addon/icons/teams.png', alt: 'Microsoft Teams', dynamic: true },
            { id: 'facebook', url: COMPANY_INFO.social.facebook, icon: 'https://nikolai-simo.github.io/simo-signature-addon/icons/facebook.png', alt: 'Facebook' },
            { id: 'instagram', url: COMPANY_INFO.social.instagram, icon: 'https://nikolai-simo.github.io/simo-signature-addon/icons/instagram.png', alt: 'Instagram' },
            { id: 'youtube', url: COMPANY_INFO.social.youtube, icon: 'https://nikolai-simo.github.io/simo-signature-addon/icons/youtube.png', alt: 'YouTube' },
            { id: 'tiktok', url: COMPANY_INFO.social.tiktok, icon: 'https://nikolai-simo.github.io/simo-signature-addon/icons/tiktok.png', alt: 'TikTok' }
        ]);

        // Fallback to icons8 if self-hosted not available
        var SOCIAL_ICONS_FALLBACK = Object.freeze({
            linkedin: 'https://content.linkedin.com/content/dam/me/business/en-us/amp/brand-site/v2/bg/LI-Bug.svg.original.svg',
            teams: 'https://img.icons8.com/color/48/microsoft-teams.png',
            facebook: 'https://img.icons8.com/color/48/facebook-new.png',
            instagram: 'https://img.icons8.com/color/48/instagram-new.png',
            youtube: 'https://img.icons8.com/color/48/youtube-play.png',
            tiktok: 'https://img.icons8.com/color/48/tiktok.png'
        });

        // ==================== STATE ====================
        var state = {
            app: {
                isOfficeReady: false,
                isInitialized: false,
                mode: 'unknown',
                lastError: null
            },
            user: {
                displayName: '',
                jobTitle: '',
                email: '',
                photoUrl: ''
            },
            settings: {
                personalMobile: '',
                companyLandline: '+49 (0)6021 3274550',
                personalEmail: '',
                showProfilePic: true,
                showPersonalMobile: false,
                showCompanyLandline: true,
                showPersonalEmail: false,
                showSocialMedia: true
            }
        };

        // ==================== DOM CACHE ====================
        var DOM = {};

        function cacheDOM() {
            DOM.loadingScreen = document.getElementById('loadingScreen');
            DOM.loadingText = document.getElementById('loadingText');
            DOM.appContent = document.getElementById('appContent');
            DOM.mainPage = document.getElementById('mainPage');
            DOM.settingsPage = document.getElementById('settingsPage');
            DOM.previewBox = document.getElementById('previewBox');
            DOM.errorDisplay = document.getElementById('errorDisplay');
            DOM.statusBadge = document.getElementById('statusBadge');
            DOM.saveIndicator = document.getElementById('saveIndicator');
            DOM.debugPanel = document.getElementById('debugPanel');
            DOM.debugLog = document.getElementById('debugLog');
            DOM.applyBtn = document.getElementById('applyBtn');
            DOM.settingsBtn = document.getElementById('settingsBtn');
            DOM.backBtn = document.getElementById('backBtn');
            DOM.saveBtn = document.getElementById('saveBtn');
            DOM.personalMobile = document.getElementById('personalMobile');
            DOM.companyLandline = document.getElementById('companyLandline');
            DOM.personalEmail = document.getElementById('personalEmail');
            DOM.toggles = {
                showProfilePic: document.getElementById('toggleProfilePic'),
                showPersonalMobile: document.getElementById('togglePersonalMobile'),
                showCompanyLandline: document.getElementById('toggleCompanyLandline'),
                showPersonalEmail: document.getElementById('togglePersonalEmail'),
                showSocialMedia: document.getElementById('toggleSocialMedia')
            };
        }

        // ==================== DEBUG LOGGING ====================
        var debugLogs = [];

        function log(message, type) {
            type = type || 'info';
            var timestamp = new Date().toLocaleTimeString();
            var logEntry = '[' + timestamp + '] [' + type.toUpperCase() + '] ' + message;
            debugLogs.push(logEntry);

            if (debugLogs.length > CONFIG.MAX_LOG_ENTRIES) {
                debugLogs.shift();
            }

            console.log(logEntry);
            updateDebugPanel();
        }

        function updateDebugPanel() {
            if (!DOM.debugLog) return;

            // Safe DOM update without innerHTML
            while (DOM.debugLog.firstChild) {
                DOM.debugLog.removeChild(DOM.debugLog.firstChild);
            }

            debugLogs.forEach(function(entry) {
                var div = document.createElement('div');
                div.textContent = entry;
                DOM.debugLog.appendChild(div);
            });
        }

        // ==================== UTILITY FUNCTIONS ====================
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            var timeout;
            return function() {
                var context = this;
                var args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, wait);
            };
        }

        function sanitizePhoneNumber(phone) {
            return phone ? phone.replace(/[^\d+\-\(\)\s]/g, '') : '';
        }

        // ==================== UI FUNCTIONS ====================
        function updateStatus(status, text) {
            if (!DOM.statusBadge) return;
            DOM.statusBadge.className = 'status-badge ' + status;
            DOM.statusBadge.textContent = text;
        }

        function updateLoadingText(text) {
            if (DOM.loadingText) {
                DOM.loadingText.textContent = text;
            }
        }

        function showError(message) {
            if (!DOM.errorDisplay) return;
            DOM.errorDisplay.textContent = message;
            DOM.errorDisplay.style.display = 'block';
            log(message, 'error');
        }

        function hideError() {
            if (DOM.errorDisplay) {
                DOM.errorDisplay.style.display = 'none';
            }
        }

        function showMainContent() {
            if (DOM.loadingScreen) DOM.loadingScreen.style.display = 'none';
            if (DOM.appContent) DOM.appContent.style.display = 'block';
        }

        function showPage(pageName) {
            if (DOM.mainPage) DOM.mainPage.classList.remove('active');
            if (DOM.settingsPage) DOM.settingsPage.classList.remove('active');

            if (pageName === 'main' && DOM.mainPage) {
                DOM.mainPage.classList.add('active');
                updatePreview();
            } else if (pageName === 'settings' && DOM.settingsPage) {
                DOM.settingsPage.classList.add('active');
            }
        }

        var toastTimeout;
        function showToast(message, type) {
            type = type || 'success';
            if (!DOM.saveIndicator) return;

            clearTimeout(toastTimeout);
            DOM.saveIndicator.textContent = message;
            DOM.saveIndicator.className = 'save-indicator show' + (type === 'error' ? ' error' : '');

            toastTimeout = setTimeout(function() {
                DOM.saveIndicator.classList.remove('show');
            }, CONFIG.TOAST_DURATION);
        }

        // ==================== SETTINGS MANAGEMENT ====================
        function loadSettings() {
            try {
                var saved = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (saved) {
                    var parsed = JSON.parse(saved);
                    Object.keys(parsed).forEach(function(key) {
                        if (state.settings.hasOwnProperty(key)) {
                            // Sanitize input
                            if (key === 'personalMobile' || key === 'companyLandline') {
                                state.settings[key] = sanitizePhoneNumber(parsed[key]);
                            } else if (typeof state.settings[key] === 'boolean') {
                                state.settings[key] = Boolean(parsed[key]);
                            } else {
                                state.settings[key] = String(parsed[key] || '');
                            }
                        }
                    });
                    log('Settings loaded from localStorage');
                }
            } catch (e) {
                log('Error loading settings: ' + e.message, 'error');
            }
        }

        function saveSettings() {
            try {
                state.settings.personalMobile = sanitizePhoneNumber(DOM.personalMobile.value);
                state.settings.companyLandline = sanitizePhoneNumber(DOM.companyLandline.value);
                state.settings.personalEmail = DOM.personalEmail.value.trim();

                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state.settings));
                showToast('Settings saved');
                log('Settings saved');
                updatePreview();
            } catch (e) {
                log('Error saving settings: ' + e.message, 'error');
                showToast('Error saving settings', 'error');
            }
        }

        function updateSettingsUI() {
            if (DOM.personalMobile) DOM.personalMobile.value = state.settings.personalMobile || '';
            if (DOM.companyLandline) DOM.companyLandline.value = state.settings.companyLandline || '';
            if (DOM.personalEmail) DOM.personalEmail.value = state.settings.personalEmail || '';

            Object.keys(DOM.toggles).forEach(function(key) {
                var toggle = DOM.toggles[key];
                if (toggle) {
                    var isChecked = state.settings[key];
                    toggle.setAttribute('aria-checked', isChecked ? 'true' : 'false');
                }
            });
        }

        function toggleSetting(settingName) {
            state.settings[settingName] = !state.settings[settingName];
            updateSettingsUI();
            log('Toggled ' + settingName + ' to ' + state.settings[settingName]);
        }

        // ==================== MICROSOFT GRAPH API ====================
        function fetchUserPhoto() {
            log('Fetching user photo from Microsoft Graph...');

            if (!Office.context || !Office.context.mailbox) {
                log('Mailbox not available for photo fetch', 'warn');
                return Promise.resolve();
            }

            return new Promise(function(resolve) {
                Office.context.mailbox.getCallbackTokenAsync({ isRest: true }, function(result) {
                    if (result.status !== 'succeeded') {
                        log('Failed to get callback token: ' + (result.error ? result.error.message : 'Unknown'), 'warn');
                        resolve();
                        return;
                    }

                    var accessToken = result.value;
                    var restUrl = Office.context.mailbox.restUrl;

                    // Fetch photo
                    fetch(restUrl + '/v2.0/me/photo/$value', {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    })
                    .then(function(response) {
                        if (!response.ok) throw new Error('Photo not found');
                        return response.blob();
                    })
                    .then(function(blob) {
                        return new Promise(function(resolveBlob) {
                            var reader = new FileReader();
                            reader.onloadend = function() {
                                state.user.photoUrl = reader.result;
                                log('Photo loaded successfully');
                                updatePreview();
                                resolveBlob();
                            };
                            reader.readAsDataURL(blob);
                        });
                    })
                    .catch(function(error) {
                        log('Photo fetch failed: ' + error.message, 'warn');
                    });

                    // Fetch job title (parallel)
                    fetch(restUrl + '/v2.0/me', {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    })
                    .then(function(response) {
                        if (!response.ok) throw new Error('Profile fetch failed');
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.jobTitle) {
                            state.user.jobTitle = data.jobTitle;
                            log('Job title loaded: ' + data.jobTitle);
                            updatePreview();
                        }
                    })
                    .catch(function(error) {
                        log('Job title fetch failed: ' + error.message, 'warn');
                    })
                    .finally(resolve);
                });
            });
        }

        // ==================== SIGNATURE GENERATION ====================
        function generateSignatureHTML() {
            var user = state.user;
            var settings = state.settings;
            var displayEmail = (settings.showPersonalEmail && settings.personalEmail)
                ? settings.personalEmail
                : user.email;

            var parts = [];

            parts.push('<table cellspacing="0" cellpadding="0" border="0" style="font-family: Arial, sans-serif; font-size: 10pt;">');
            parts.push('<tbody>');

            // Name and title
            parts.push('<tr><td style="padding-bottom: 10px;">');
            parts.push('<span style="font-size: 14pt; color: #152979; font-weight: bold;">' + escapeHtml(user.displayName) + '</span><br>');
            if (user.jobTitle) {
                parts.push('<span style="color: #9a9a9a;">' + escapeHtml(user.jobTitle) + '</span><br>');
            }
            parts.push('</td></tr>');

            // Profile picture
            if (settings.showProfilePic && user.photoUrl) {
                parts.push('<tr><td style="padding-bottom: 10px;">');
                parts.push('<img src="' + user.photoUrl + '" width="' + CONFIG.PHOTO_SIZE + '" height="' + CONFIG.PHOTO_SIZE + '" style="border-radius: 50%; display: block;" alt="Profile Photo">');
                parts.push('</td></tr>');
            }

            // Contact info
            parts.push('<tr><td style="padding-bottom: 10px;">');
            parts.push('<span style="color: #9a9a9a;">email. <a href="mailto:' + escapeHtml(displayEmail) + '" style="color: #9a9a9a; text-decoration: none;">' + escapeHtml(displayEmail) + '</a></span><br>');
            if (settings.showPersonalMobile && settings.personalMobile) {
                var mobileClean = settings.personalMobile.replace(/\s/g, '');
                parts.push('<span style="color: #9a9a9a;">mobile. <a href="tel:' + escapeHtml(mobileClean) + '" style="color: #9a9a9a; text-decoration: none;">' + escapeHtml(settings.personalMobile) + '</a></span><br>');
            }
            parts.push('</td></tr>');

            // Company logo
            parts.push('<tr><td style="padding-top: 10px; padding-bottom: 10px;">');
            parts.push('<a href="' + COMPANY_INFO.website + '"><img src="' + COMPANY_INFO.logoUrl + '" width="150" height="49" alt="SIMO Logo" style="display: block;" border="0"></a>');
            parts.push('</td></tr>');

            // Company address
            parts.push('<tr><td style="padding-bottom: 10px;">');
            parts.push('<span style="color: #9a9a9a;">' + escapeHtml(COMPANY_INFO.address) + '<br>' + escapeHtml(COMPANY_INFO.city) + '</span><br>');
            if (settings.showCompanyLandline && settings.companyLandline) {
                var phoneClean = settings.companyLandline.replace(/\s/g, '');
                parts.push('<span style="color: #9a9a9a;"><a href="tel:' + phoneClean + '" style="color: #9a9a9a; text-decoration: none;">' + escapeHtml(settings.companyLandline) + '</a></span><br>');
            }
            parts.push('<span style="color: #9a9a9a;">' + escapeHtml(COMPANY_INFO.fax) + ' (Fax)</span><br>');
            parts.push('<span style="color: #9a9a9a;"><a href="mailto:' + COMPANY_INFO.email + '" style="color: #9a9a9a; text-decoration: none;">' + COMPANY_INFO.email + '</a></span>');
            parts.push('</td></tr>');

            // Social media icons
            if (settings.showSocialMedia) {
                parts.push('<tr><td style="padding-top: 10px; padding-bottom: 10px;">');
                parts.push('<div style="padding-top: 8px; line-height: 0;">');

                SOCIAL_ICONS.forEach(function(social) {
                    var url = social.dynamic
                        ? 'https://teams.microsoft.com/l/chat/0/0?users=' + encodeURIComponent(user.email)
                        : social.url;
                    var iconUrl = SOCIAL_ICONS_FALLBACK[social.id] || social.icon;

                    parts.push('<a href="' + url + '" style="text-decoration: none; display: inline-block; margin-right: 8px;" target="_blank">');
                    parts.push('<img src="' + iconUrl + '" width="' + CONFIG.ICON_SIZE + '" height="' + CONFIG.ICON_SIZE + '" alt="' + social.alt + '" border="0" style="vertical-align: middle;">');
                    parts.push('</a>');
                });

                parts.push('</div>');
                parts.push('</td></tr>');
            }

            parts.push('</tbody></table>');

            return parts.join('');
        }

        var updatePreview = debounce(function() {
            if (DOM.previewBox) {
                DOM.previewBox.innerHTML = generateSignatureHTML();
            }
        }, 100);

        // ==================== APPLY SIGNATURE ====================
        function applySignature() {
            log('applySignature called. Mode: ' + state.app.mode);
            hideError();

            var signatureHTML = generateSignatureHTML();
            updatePreview();

            if (state.app.mode === 'test') {
                log('Test mode - showing preview only');
                showToast('Preview updated (Test Mode)');
                return;
            }

            if (state.app.mode !== 'outlook' || !state.app.isOfficeReady) {
                log('Office not ready', 'error');
                showError('Add-in is still loading. Please wait a moment and try again.');
                showToast('Not ready - please wait', 'error');
                return;
            }

            log('Attempting to insert signature into email...');

            try {
                if (!Office.context || !Office.context.mailbox || !Office.context.mailbox.item) {
                    throw new Error('No active email compose window detected. Please open a new email first.');
                }

                var item = Office.context.mailbox.item;

                if (!item.body || typeof item.body.setSelectedDataAsync !== 'function') {
                    throw new Error('Email body API not available. This may be a permissions issue.');
                }

                item.body.setSelectedDataAsync(
                    signatureHTML,
                    { coercionType: Office.CoercionType.Html },
                    function(asyncResult) {
                        if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
                            log('Signature inserted successfully');
                            showToast('Signature applied!');
                        } else {
                            var errorMsg = asyncResult.error ? asyncResult.error.message : 'Unknown error';
                            log('Failed to insert signature: ' + errorMsg, 'error');
                            showError('Could not apply signature: ' + errorMsg);
                            showToast('Failed to apply signature', 'error');
                        }
                    }
                );
            } catch (e) {
                log('Exception in applySignature: ' + e.message, 'error');
                showError(e.message);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // ==================== INITIALIZATION ====================
        function initializeOutlookMode() {
            if (state.app.isInitialized) {
                log('Already initialized, skipping');
                return;
            }

            log('Initializing Outlook mode...');
            state.app.mode = 'outlook';
            state.app.isOfficeReady = true;
            state.app.isInitialized = true;

            updateStatus('ready', 'Ready');
            updateLoadingText('Loading user profile...');

            try {
                var mailbox = Office.context.mailbox;
                if (mailbox && mailbox.userProfile) {
                    state.user.displayName = mailbox.userProfile.displayName || '[Your Name]';
                    state.user.email = mailbox.userProfile.emailAddress || '';
                    log('User profile loaded: ' + state.user.displayName + ' <' + state.user.email + '>');
                } else {
                    log('userProfile not available on mailbox', 'warn');
                    state.user.displayName = '[Your Name]';
                    state.user.email = '[your.email@simo-online.com]';
                }
            } catch (e) {
                log('Error loading user profile: ' + e.message, 'error');
                state.user.displayName = '[Your Name]';
                state.user.email = '[your.email@simo-online.com]';
            }

            loadSettings();
            updateSettingsUI();
            updatePreview();
            showMainContent();
            log('Outlook mode initialization complete');

            // Fetch photo and job title async
            fetchUserPhoto();
        }

        function initializeTestMode() {
            if (state.app.isInitialized) {
                log('Already initialized, skipping');
                return;
            }

            log('Initializing Test/Browser mode...');
            state.app.mode = 'test';
            state.app.isOfficeReady = false;
            state.app.isInitialized = true;

            updateStatus('test', 'Test Mode');

            state.user.displayName = '[Your Name]';
            state.user.jobTitle = '[Your Job Title]';
            state.user.email = '[your.email@simo-online.com]';

            loadSettings();
            updateSettingsUI();
            updatePreview();
            showMainContent();

            showToast('Running in Test Mode - signatures will show in preview only', 'warning');
            log('Test mode initialization complete');
        }

        function attemptFallbackInit() {
            log('Attempting fallback initialization...');

            try {
                if (typeof Office !== 'undefined' && Office.context && Office.context.mailbox) {
                    log('Office.context.mailbox available via fallback');
                    initializeOutlookMode();
                } else {
                    log('Office.context.mailbox not available, using test mode', 'warn');
                    initializeTestMode();
                }
            } catch (e) {
                log('Fallback failed: ' + e.message, 'error');
                initializeTestMode();
            }
        }

        function initialize() {
            log('Starting initialization... (v' + CONFIG.VERSION + ')');
            cacheDOM();
            bindEvents();
            updateLoadingText('Checking Office.js...');

            if (typeof Office === 'undefined') {
                log('Office.js not loaded, starting test mode', 'warn');
                initializeTestMode();
                return;
            }

            log('Office.js detected, waiting for Office.onReady...');
            updateLoadingText('Connecting to Outlook...');

            Office.onReady(function(info) {
                log('Office.onReady fired. Host: ' + (info.host || 'unknown') + ', Platform: ' + (info.platform || 'unknown'));

                if (info.host === Office.HostType.Outlook) {
                    initializeOutlookMode();
                } else {
                    log('Not running in Outlook host, starting test mode', 'warn');
                    initializeTestMode();
                }
            });

            setTimeout(function() {
                if (!state.app.isInitialized) {
                    log('Timeout waiting for Office.onReady, attempting fallback...', 'warn');
                    attemptFallbackInit();
                }
            }, CONFIG.INIT_TIMEOUT);
        }

        // ==================== EVENT BINDING ====================
        function bindEvents() {
            // Button clicks
            if (DOM.applyBtn) {
                DOM.applyBtn.addEventListener('click', applySignature);
            }
            if (DOM.settingsBtn) {
                DOM.settingsBtn.addEventListener('click', function() { showPage('settings'); });
            }
            if (DOM.backBtn) {
                DOM.backBtn.addEventListener('click', function() { showPage('main'); });
            }
            if (DOM.saveBtn) {
                DOM.saveBtn.addEventListener('click', saveSettings);
            }

            // Toggle switches
            Object.keys(DOM.toggles).forEach(function(key) {
                var toggle = DOM.toggles[key];
                if (toggle) {
                    toggle.addEventListener('click', function() {
                        toggleSetting(key);
                    });
                    toggle.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggleSetting(key);
                        }
                    });
                }
            });

            // Debug panel shortcut
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    e.preventDefault();
                    if (DOM.debugPanel) {
                        DOM.debugPanel.classList.toggle('show');
                    }
                }
            });
        }

        // ==================== START ====================
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    })();
    </script>
</body>
</html>
