<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMO Email Signatures</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: #3d5875;
            color: white;
            padding: 16px 24px;
            border-bottom: 3px solid #2a3f54;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .container {
            padding: 20px;
            padding-bottom: 80px;
        }

        /* Loading Screen */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3d5875;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
            color: #666;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #f6f8fa;
        }

        .tab-btn.active {
            color: #3d5875;
            border-bottom-color: #3d5875;
            background: #fafbfc;
        }

        /* Views */
        .view {
            display: none;
            background: white;
            border: 1px solid #e1e4e8;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 20px;
        }

        .view.active {
            display: block;
        }

        /* Signature Section */
        .section {
            background: #fafbfc;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-header {
            background: #f6f8fa;
            border-bottom: 1px solid #e1e4e8;
            padding: 12px 16px;
            font-weight: 600;
            font-size: 14px;
        }

        #signatureList {
            display: flex;
            flex-direction: column;
        }

        .signature-btn {
            background: white;
            border: none;
            border-bottom: 1px solid #e1e4e8;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .signature-btn:last-child {
            border-bottom: none;
        }

        .signature-btn:hover {
            background: #f6f8fa;
        }

        .signature-btn:active {
            background: #e8f4f8;
        }

        .signature-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .signature-info {
            flex: 1;
        }

        .signature-info h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .signature-info p {
            font-size: 12px;
            color: #666;
        }

        .btn-primary {
            background: #3d5875;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #2a3f54;
        }

        .preview-box {
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            background: white;
            max-height: 300px;
            overflow-y: auto;
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üñäÔ∏è SIMO Email Signatures</h1>
        <p>Professional signatures for your organization</p>
    </div>

    <div class="container">
        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen">
            <div class="spinner"></div>
            <div class="loading-text">Initializing add-in...</div>
        </div>

        <!-- Main Content (hidden until Office.js loads) -->
        <div id="mainContent" style="display: none;">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('signatures')">üìß Signatures</button>
            </div>

            <!-- Signatures View -->
            <div id="signaturesView" class="view active">
                <div class="section">
                    <div class="section-header">Pre-configured Signatures</div>
                    <div id="signatureList">
                        <!-- Buttons will be added here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">‚úì Signature applied</div>

    <script>
        let userProfile = {};
        let isOfficeReady = false;

        // Default settings
        let userSettings = {
            jobTitle: '',
            includePhone: false,
            phone: '',
            mobile: '',
            font: 'Arial',
            nameSize: '14pt',
            bodySize: '10pt',
            nameColor: '#152979',
            titleColor: '#9a9a9a',
            contactColor: '#9a9a9a',
            showLinkedIn: true,
            showTeams: true
        };

        // CRITICAL: Dual initialization approach for maximum compatibility
        Office.onReady(function(info) {
            console.log('Office.onReady fired', info);
            initializeAddin();
        });

        // Fallback for older Office versions
        Office.initialize = function(reason) {
            console.log('Office.initialize fired', reason);
            if (!isOfficeReady) {
                initializeAddin();
            }
        };

        function initializeAddin() {
            try {
                isOfficeReady = true;
                console.log('Initializing SIMO Signatures add-in...');
                
                // Hide loading, show content
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                
                loadSettings();
                getUserProfile();
                loadSignatures();
                
                console.log('Add-in initialized successfully');
            } catch (error) {
                console.error('Error initializing add-in:', error);
                document.getElementById('loadingScreen').innerHTML = `
                    <div style="text-align: center; color: #dc3545;">
                        <h3>Error Loading Add-in</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            if (tab === 'signatures') {
                document.getElementById('signaturesView').classList.add('active');
            }
        }

        function getUserProfile() {
            try {
                userProfile = {
                    displayName: Office.context.mailbox.userProfile.displayName || '[Your Name]',
                    email: Office.context.mailbox.userProfile.emailAddress || '[email@example.com]'
                };
                console.log('User profile loaded:', userProfile);
            } catch (error) {
                console.error('Error getting user profile:', error);
                userProfile = {
                    displayName: '[Your Name]',
                    email: '[email@example.com]'
                };
            }
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('simoSignatureSettings');
                if (saved) {
                    userSettings = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function loadSignatures() {
            const signatureList = document.getElementById('signatureList');
            
            const signatures = [
                {
                    name: 'Default Signature',
                    description: 'Standard SIMO employee signature',
                    icon: 'üìß'
                },
                {
                    name: 'All Mail Signature',
                    description: 'Signature with legal disclaimer',
                    icon: 'üìÑ'
                }
            ];

            signatureList.innerHTML = signatures.map((sig, index) => `
                <button class="signature-btn" onclick="applySignature(${index})">
                    <div class="signature-icon">${sig.icon}</div>
                    <div class="signature-info">
                        <h3>${sig.name}</h3>
                        <p>${sig.description}</p>
                    </div>
                </button>
            `).join('');
        }

        function getDefaultSignatureHTML() {
            const jobTitle = userSettings.jobTitle || '[Job Title]';
            const phone = userSettings.phone || '[Phone]';
            const mobile = userSettings.mobile || '[Mobile]';
            
            let phoneHTML = '';
            if (userSettings.includePhone) {
                if (userSettings.phone) {
                    phoneHTML += `phone. <a href="tel:${phone}" style="color: ${userSettings.contactColor}; text-decoration: none;">${phone}</a><br>`;
                }
                if (userSettings.mobile) {
                    phoneHTML += `mobile. <a href="tel:${mobile}" style="color: ${userSettings.contactColor}; text-decoration: none;">${mobile}</a><br>`;
                }
            }

            let socialHTML = '';
            if (userSettings.showLinkedIn || userSettings.showTeams) {
                socialHTML = '<tr><td valign="top" style="padding-bottom: 10px; padding-top: 10px;">';
                if (userSettings.showLinkedIn) {
                    socialHTML += '<a href="https://www.linkedin.com/company/simo-online" style="text-decoration: none;"><img src="https://nikolai-simo.github.io/simo-signature-addon/linkedin-icon.png" border="0" width="32" height="32" alt="LinkedIn" style="display: inline-block; margin-right: 8px;"></a>';
                }
                if (userSettings.showTeams) {
                    socialHTML += `<a href="https://teams.microsoft.com/l/chat/0/0?users=${userProfile.email}" style="text-decoration: none;"><img src="https://nikolai-simo.github.io/simo-signature-addon/teams-icon.png" border="0" width="32" height="32" alt="Microsoft Teams" style="display: inline-block;"></a>`;
                }
                socialHTML += '</td></tr>';
            }

            return `<table style="WIDTH: 508px; FONT-SIZE: ${userSettings.bodySize}; FONT-FAMILY: ${userSettings.font}; MARGIN-TOP: 0px; MARGIN-BOTTOM: 5pt" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td style="FONT-SIZE: ${userSettings.bodySize}; FONT-FAMILY: ${userSettings.font}; PADDING-BOTTOM: 10px" valign="top"><span style="FONT-SIZE: ${userSettings.nameSize}"><strong><font color="${userSettings.nameColor}">${userProfile.displayName}</font></strong></span><br><span style="font-size: ${userSettings.bodySize}; color: ${userSettings.titleColor};">${jobTitle}</span><br><br><span style="font-size: ${userSettings.bodySize}; color: ${userSettings.contactColor};">${phoneHTML}email. <a href="mailto:${userProfile.email}" style="color: ${userSettings.contactColor}; text-decoration: none;">${userProfile.email}</a></span></td></tr></tbody></table><table cellspacing="0" cellpadding="0" border="0" style="font-size: ${userSettings.bodySize}; WIDTH: 508px"><tbody><tr><td valign="top" style="padding-bottom: 10px; padding-top: 10px;"><a href="https://www.simo-online.com/"><img src="https://nikolai-simo.github.io/simo-signature-addon/simo-logo.png" border="0" width="150" height="49" alt="SIMO logo" style="display: block;"></a></td></tr>${socialHTML}</tbody></table>`;
        }

        function getAllMailSignatureHTML() {
            const defaultSig = getDefaultSignatureHTML();
            return defaultSig + `<hr style="color: rgb(197, 200, 203); margin-top: 20px;"><p style="color: rgb(197, 200, 203); font-size: 8pt; font-family: ${userSettings.font}; margin-top: 5pt;">Diese E-Mail enthaelt vertrauliche und/oder rechtlich geschuetzte Informationen. Wenn Sie nicht der beabsichtigte Empfaenger sind, informieren Sie bitte sofort den Absender und loeschen Sie diese E-Mail. Das unbefugte Kopieren dieser E-Mail oder die unbefugte Weitergabe der enthaltenen Informationen ist nicht gestattet. /|/ The information contained in this message is confidential or protected by law. If you are not the intended recipient, please contact the sender and delete this message. Any unauthorised copying of this message or unauthorised distribution of the information contained herein is prohibited.</p><hr style="color: rgb(197, 200, 203);"><p style="color: rgb(197, 200, 203); font-size: 8pt; font-family: ${userSettings.font}; margin-top: 5pt;">Legally required information for business correspondence/ Gesetzliche Pflichtangaben fuer Geschaeftskorrespondenz<br>Unternehmen/Company: SIMO GmbH mit Sitz/with registered seat in Aschaffenburg, Amtsgericht/local court Aschaffenburg HRB 15769, Umsatzsteuer-Identifikationsnummer / VAT-ID DE335322803, Geschaeftsanschrift: W√ºrzburger Stra√üe 152, 63743 Aschaffenburg<br>Geschaeftsfuehrung/Management Board: Thomas Wassum und Andreas O. Schwan</p>`;
        }

        function applySignature(index) {
            if (!isOfficeReady) {
                alert('Add-in is still loading. Please wait...');
                return;
            }

            try {
                const signatures = [
                    { html: getDefaultSignatureHTML() },
                    { html: getAllMailSignatureHTML() }
                ];

                const signatureHTML = signatures[index].html;

                Office.context.mailbox.item.body.setSignatureAsync(
                    signatureHTML,
                    { coercionType: Office.CoercionType.Html },
                    function(asyncResult) {
                        if (asyncResult.status === Office.AsyncResultStatus.Failed) {
                            alert('Error applying signature: ' + asyncResult.error.message);
                        } else {
                            const indicator = document.getElementById('saveIndicator');
                            indicator.classList.add('show');
                            setTimeout(() => indicator.classList.remove('show'), 2000);
                        }
                    }
                );
            } catch (error) {
                alert('Error: ' + error.message);
                console.error('Error applying signature:', error);
            }
        }
    </script>
</body>
</html>
